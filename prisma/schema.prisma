generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email       String   @unique
  clerkUserId String?  @unique
  name        String?
  displayName String?
  fullName    String?
  address     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  profile   UserProfile?
  disputes  Dispute[]
  fundings  FundingApplication[]
  creditItems CreditItem[]
  activities  Activity[]
  notifications Notification[]
  settings    UserSettings?
  creditProfiles CreditProfile[]
  emotionalSnapshots EmotionalSnapshot[]
  journeys    Journey[]
  systemEvents SystemEvent[]
  creditReports CreditReport[]
  fundingProfile FundingProfile?
  documents      Document[]
  timelineEvents TimelineEvent[]
  narrativeEvents NarrativeEvent[]
  presence       Presence[]
  emotionalHistory EmotionalRecord[]
  personaHistory   PersonaState[]
  kernelStates     KernelState[]

  // Kernel Relations
  tenantId         String?
  tenant           Tenant?       @relation(fields: [tenantId], references: [id])
  decisionCards    DecisionCard[]
  eventLogs        EventLog[]
}

model KernelState {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  emotionalState String
  personaMode    String
  lastInsight    String?
  lastAction     String?
  lastNarrative  String?
  lastPresence   String?
  timestamp     DateTime @default(now())
}

model Presence {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  surface       String
  device        String
  emotionalState String
  personaMode    String
  timestamp     DateTime @default(now())
}

model EmotionalRecord {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  state         String
  intensity     Int
  cause         String
  transitionFrom String?
  transitionTo   String?
  timestamp     DateTime @default(now())
}

model PersonaState {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  mode      String
  tone      String
  pacing    String
  motion    String
  color     String
  timestamp DateTime @default(now())
}

model Document {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  title       String
  type        String
  url         String
  fundingId   String?
  funding     FundingApplication? @relation(fields: [fundingId], references: [id])
  disputeId   String?
  dispute     Dispute? @relation(fields: [disputeId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model UserProfile {
  id          String   @id @default(cuid())
  user        User     @relation(fields: [userId], references: [id])
  userId      String   @unique
  emailFallback String? // Fallback for profile creation if needed
  emotionalNote String? // short emotional context / pacing note
  story       String?   // userâ€™s narrative / identity story
  emotionalState EmotionalState @default(NEUTRAL) // WORST, NEUTRAL, PROGRESSING, THRIVING
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model SystemEvent {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  type      String
  details   String?
  createdAt DateTime @default(now())
}

model CreditReport {
  id          String       @id @default(cuid())
  userId      String
  user        User         @relation(fields: [userId], references: [id])
  source      String?      // e.g. uploaded_pdf
  fileUrl     String?
  rawText     String?
  items       CreditItem[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model FundingProfile {
  id           String               @id @default(cuid())
  userId       String               @unique
  user         User                 @relation(fields: [userId], references: [id])
  score        Int?
  applications FundingApplication[]
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
}

model Bank {
  id        String        @id @default(cuid())
  name      String
  products  BankProduct[]
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
}

model BankProduct {
  id        String   @id @default(cuid())
  bankId    String
  bank      Bank     @relation(fields: [bankId], references: [id])
  name      String
  minScore  Int
  maxScore  Int
  maxAmount Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum DisputeStatus {
  PENDING
  OPEN
  IN_PROGRESS
  RESOLVED
  REJECTED
}

enum RoundStatus {
  DRAFT
  SUBMITTED
  COMPLETED
}

enum EmotionalState {
  WORST
  NEUTRAL
  PROGRESSING
  THRIVING
}

enum TimelineEventType {
  STATUS_CHANGED
  ROUND_CREATED
  ROUND_SUBMITTED
  EVIDENCE_ADDED
  BUREAU_RESPONSE
}

enum BureauStatus {
  VERIFIED
  DELETED
  UPDATED
}

model DisputeRound {
  id              String           @id @default(cuid())
  disputeId       String
  dispute         Dispute          @relation(fields: [disputeId], references: [id])
  roundNumber     Int
  status          RoundStatus      @default(DRAFT) // DRAFT, SUBMITTED, COMPLETED
  submittedAt     DateTime?
  bureauResponses BureauResponse[]
  evidence        Evidence[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
}

model Letter {
  id        String   @id @default(cuid())
  disputeId String
  dispute   Dispute  @relation(fields: [disputeId], references: [id])
  type      String   // INITIAL, FOLLOWUP, etc.
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Evidence {
  id        String        @id @default(cuid())
  disputeId String?
  dispute   Dispute?      @relation(fields: [disputeId], references: [id])
  roundId   String?
  round     DisputeRound? @relation(fields: [roundId], references: [id])
  itemId    String?
  item      CreditItem?   @relation(fields: [itemId], references: [id])
  url       String
  type      String        // IDENTITY, ADDRESS, ACCOUNT, etc.
  createdAt DateTime      @default(now())
}

model BureauResponse {
  id        String       @id @default(cuid())
  roundId   String
  round     DisputeRound @relation(fields: [roundId], references: [id])
  bureau    String       // EXPERIAN, EQUIFAX, TRANSUNION
  status    BureauStatus // VERIFIED, DELETED, UPDATED
  message   String?
  createdAt DateTime     @default(now())
}

model TimelineEvent {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  disputeId String?
  dispute   Dispute?  @relation(fields: [disputeId], references: [id])
  title     String
  message   String
  type      String   // progress | insight | milestone | emotional | system
  createdAt DateTime @default(now())
}

model NarrativeEvent {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  arc       String   // emotional | repair | expansion | etc.
  message   String
  type      String   // progress | insight | milestone | emotional | system
  createdAt DateTime @default(now())
}

model Dispute {
  id            String        @id @default(cuid())
  user          User          @relation(fields: [userId], references: [id])
  userId        String
  bureau        String        // EXPERIAN, EQUIFAX, TRANSUNION, OTHER
  creditorName  String
  accountNumber String?
  reason        String
  status        DisputeStatus @default(OPEN) // OPEN, IN_PROGRESS, RESOLVED, REJECTED
  emotionalTone String?       // optional emotional tag
  creditItemId  String?
  creditItem    CreditItem?   @relation(fields: [creditItemId], references: [id])
  rounds        DisputeRound[]
  letters       Letter[]
  evidence      Evidence[]
  timeline      TimelineEvent[]
  documents     Document[]
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model FundingApplication {
  id              String              @id @default(cuid())
  user            User                @relation(fields: [userId], references: [id])
  userId          String
  profileId       String?
  productId       String?
  productType     String              // CREDIT_CARD, LINE_OF_CREDIT, TERM_LOAN, GRANT, OTHER
  requestedAmount Float
  status          String              @default("PENDING") // PENDING, APPROVED, DECLINED, WITHDRAWN
  fundingType     String              @default("PERSONAL")
  notes           String?
  emotionalTone   String?
  fundingProfileId String?
  fundingProfile   FundingProfile?    @relation(fields: [fundingProfileId], references: [id])
  documents        Document[]
  submittedAt      DateTime?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
}

model CreditItem {
  id            String        @id @default(cuid())
  user          User          @relation(fields: [userId], references: [id])
  userId        String
  reportId      String?
  creditorName  String
  accountNumber String?
  balance       Float?
  status        String        @default("OPEN") // OPEN, CLOSED, CHARGED_OFF, COLLECTION
  emotionalTone String?
  isNegative    Boolean       @default(false)
  isDisputed    Boolean       @default(false)
  disputes      Dispute[]
  evidence      Evidence[]
  report        CreditReport? @relation(fields: [reportId], references: [id])
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model Activity {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  type      String   // CREDIT_ITEM_CREATED, DISPUTE_CREATED, etc.
  message   String
  createdAt DateTime @default(now())
}

model Notification {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
}

model UserSettings {
  id                     String   @id @default(cuid())
  user                   User     @relation(fields: [userId], references: [id])
  userId                 String   @unique
  themeOverride          String   @default("SYSTEM") // SYSTEM, LIGHT, DARK
  notificationsEnabled   Boolean  @default(true)
  emotionalEngineEnabled Boolean  @default(true)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
}

model CreditProfile {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  score     Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EmotionalSnapshot {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  mode      String   // neutral, positive, negative, etc.
  intensity Float    // 0.0 to 1.0
  notes     String?
  createdAt DateTime @default(now())
}

model Journey {
  id          String   @id @default(cuid())
  user        User     @relation(fields: [userId], references: [id])
  userId      String
  title       String
  description String?
  status      String   @default("ACTIVE") // ACTIVE, COMPLETED, ARCHIVED
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// --------------------------------------
// KERNEL MODELS (Day 1-2)
// --------------------------------------

model Tenant {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  users     User[]
  financeSnapshots FinanceSnapshot[]
  fundingReadiness FundingReadiness?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DecisionCard {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id])
  title       String
  description String?
  status      String    @default("PENDING") // PENDING | APPROVED | REJECTED | HOLD | EXPIRED
  type        String    @default("INFO")    // INFO | ACTION | URGENT | CFO | MARKETING | COMPLIANCE | FUNDING | ML
  actionLabel String?
  actionUrl   String?
  priority    Int       @default(0)
  requestId   String?
  expiresAt   DateTime?
  approvedAt  DateTime?
  rejectedAt  DateTime?
  heldAt      DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model EventLog {
  id        String   @id @default(cuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  tenantId  String?
  action    String
  resource  String
  metadata  String?  // JSON stringified
  ip        String?
  userAgent String?
  createdAt DateTime @default(now())
}

model MotherboardLock {
  id        String   @id @default(cuid())
  tenantId  String   @unique
  lockedAt  DateTime @default(now())
  expiresAt DateTime
}

model FinanceSnapshot {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  period    String   // e.g. "2026-02"
  revenue   Int      // cents
  expenses  Int      // cents
  notes     String?

  @@unique([tenantId, period])
  @@index([tenantId, createdAt])
}

// --------------------------------------
// CREDITOR INTELLIGENCE (Packet 3)
// --------------------------------------

model Creditor {
  id         String   @id @default(cuid())
  createdAt  DateTime @default(now())

  name       String
  normalized String   @unique
  category   String?

  addresses  CreditorAddress[]
  bureauRules BureauRule[]
  outcomes   DisputeOutcome[]

  @@index([name])
}

model CreditorAddress {
  id         String   @id @default(cuid())
  creditorId String
  creditor   Creditor @relation(fields: [creditorId], references: [id], onDelete: Cascade)

  bureau     String   // EX, EQ, TU
  address    String
  active     Boolean  @default(true)

  @@index([bureau])
}

model BureauRule {
  id         String   @id @default(cuid())
  creditorId String
  creditor   Creditor @relation(fields: [creditorId], references: [id], onDelete: Cascade)

  bureau     String
  notes      String?
  preferredDisputeType String?

  @@index([bureau])
}

model DisputeOutcome {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())

  creditorId  String
  creditor    Creditor @relation(fields: [creditorId], references: [id], onDelete: Cascade)

  bureau      String
  disputeType String
  result      String   // VERIFIED, DELETED, UPDATED
  daysToResponse Int?

  @@index([creditorId])
  @@index([bureau])
}

// --------------------------------------
// FUNDING INTELLIGENCE (Packet 4)
// --------------------------------------

model FundingReadiness {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenantId      String   @unique
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  personalScore Int?
  utilization   Float?
  inquiries6m   Int?
  openAccounts  Int?
  negativeItems Int?

  readinessScore Int?
  readinessBand  String?  // LOW | MODERATE | STRONG

  lastSimulatedAt DateTime?
}
